name: Century Protocol QA

on:
  push:
    branches: ["main"]
  pull_request:
    branches: ["main", "feature/*"]

jobs:
  # JOB 1: SYNTAX CHECK
  markdown-lint:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v3
      - name: Run Markdown Lint
        uses: DavidAnson/markdownlint-cli2-action@v16
        with:
          globs: "**/*.md"

  # JOB 2: ENFORCE NAMING (BRAINS ONLY)
  protocol-enforcer:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v3
      - name: Verify Gem Brains Structure
        run: |
          echo "üîç Scanning 'brains/' for Century Protocol compliance..."

          # Regex: Enforces 000-899 numbers and kebab-case.
          REGEX="^[0-9]{3}-[a-z]+-[a-z0-9-]+\.md$"

          ERROR_COUNT=0

          if [ -d "brains" ]; then
            cd brains
            if [ -n "$(ls -A . 2>/dev/null)" ]; then
              for file in *.md; do
                if [[ "$file" == ".gitkeep" ]]; then continue; fi # Ignore placeholder

                if [[ ! "$file" =~ $REGEX ]]; then
                  echo "‚ùå VIOLATION: '$file' invalid. Must be '000-899-category-name.md' (kebab-case)."
                  ERROR_COUNT=$((ERROR_COUNT+1))
                else
                  # Check the number range
                  file_number=$(echo "$file" | cut -d'-' -f1)
                  if (( 10#$file_number < 0 || 10#$file_number > 899 )); then
                    echo "‚ùå VIOLATION: '$file' number ($file_number) is outside the 000-899 Brains range."
                    ERROR_COUNT=$((ERROR_COUNT+1))
                  fi
                  echo "‚úÖ OK: $file"
                fi
              done
            fi
          else
            echo "‚ö†Ô∏è 'brains' directory missing!"
            exit 1
          fi

          if [ $ERROR_COUNT -gt 0 ]; then
            echo "üö´ FAILED: Found $ERROR_COUNT violation(s). Fix filenames before merging."
            exit 1
          fi
